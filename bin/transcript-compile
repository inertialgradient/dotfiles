#!/usr/bin/env ruby
# frozen_string_literal: true

Section = Struct.new(:number, :header, :body)

FORCE_RECOMPILE = ARGV.include?("--force")
TRANSCRIPTS_FILE = "#{File.basename(Dir.pwd)}-transcripts.md"
SUMMARIES_FILE = "#{File.basename(Dir.pwd)}-summaries.md"
VTT_FILES = Dir.glob("*.vtt")
TRANSCRIPTS = {}
SUMMARIES = {}

def format_vtt_md_entry(file)
  lines = File.read(file).split(/^[[:digit:]]+$/).map(&:strip).slice(1..)
  vtt_lines = lines.map do |line|
    timestamp, speech = line.split(/\.[[:digit:]]{3}\s-->.+\n/)
    [timestamp, speech.gsub("\n", " ")].join(" ")
  end
  "```\n#{vtt_lines.join("\n")}\n```"
end

def parse_header(lines)
  lines
    .sub(".vtt", "")
    .gsub("_", " ")
    .sub(/^([[:alnum:].]+)[-\s](.+)/, "\\1<+>\\2")
    .split("<+>")
end

def parse_compiled_file(file)
  File.read(file).split(/^#\s/).reject(&:empty?).map do |section|
    header, *contents = section.split("\n")
    contents.reject!(&:empty?)
    contents.shift if contents.first.start_with?("## ")
    section_num, *header = header.split(". ")
    Section.new(section_num, header.join(" "), contents.join("\n").strip)
  end
end

puts "Checking for transcripts file at #{TRANSCRIPTS_FILE}..."
if VTT_FILES.empty? && !File.exist?(TRANSCRIPTS_FILE)
  puts "> Found no VTT files and no existing transcript file. Quitting."
  exit(1)
end

if File.exist?(TRANSCRIPTS_FILE) && !FORCE_RECOMPILE
  puts "> Compiled transcripts file found. Reading."
  parse_compiled_file(TRANSCRIPTS_FILE).each { TRANSCRIPTS[_1.number] = _1 }
else
  puts "> #{VTT_FILES.size} VTT files found. Compiling."
  VTT_FILES.each do |file|
    section_num, header = parse_header(file)
    TRANSCRIPTS[section_num] =
      Section.new(section_num, header, format_vtt_md_entry(file))
  end
end

puts "Checking for summaries file at #{SUMMARIES_FILE}..."
if File.exist?(SUMMARIES_FILE)
  puts "> Summaries file found. Reading."
  parse_compiled_file(SUMMARIES_FILE).each { SUMMARIES[_1.number] = _1 }
else
  puts "> No summaries file found. Skipping."
end

printf "Writing to %s...", TRANSCRIPTS_FILE
File.open(TRANSCRIPTS_FILE, "w+") do |file|
  TRANSCRIPTS.each do |section_num, transcript|
    summary = SUMMARIES[section_num]&.body
    file.puts("# #{section_num} #{transcript.header}\n\n")
    file.puts("## Summary\n\n#{summary}\n\n") if summary
    file.puts("## Transcript\n\n#{transcript.body}\n\n")
  end
end

printf "done.\n"
