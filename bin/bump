#!/usr/bin/env bash

set -e

# Ensure inside tmux
if [ -z "$TMUX" ]; then
  tmux new-session -d -s updates
  tmux attach -t updates
fi

WINDOW="updates-$(date +%H:%M)"
tmux new-window -n "$WINDOW"

# Capture the ID of the first pane
PANE0=$(tmux display-message -p -t "$WINDOW" '#{pane_id}')

# Run dotfiles + vim in pane 0
tmux send-keys -t "$PANE0" \
  "cd ~/.dotfiles && git pull --rebase --autostash" C-m
tmux send-keys -t "$PANE0" \
  "vim +PlugInstall +PlugUpgrade +PlugUpdate +qall" C-m

# Create pane 1
PANE1=$(tmux split-window -h -t "$PANE0" \
  -P -F '#{pane_id}' \
  "doom upgrade && doom sync && bump-submodules")

# Create pane 2
PANE2=$(tmux split-window -h -t "$PANE1" \
  -P -F '#{pane_id}' \
  "export HOMEBREW_NO_INSTALL_CLEANUP=1; brew update && brew upgrade && brew cleanup")

tmux select-layout -t "$WINDOW" even-horizontal

# Optional hosts update: always in pane 0
if [[ "$1" == "--hosts" ]]; then
  echo "Updating hosts file..."
  sleep 3
  tmux send-keys -t "$PANE0" "update-hosts" C-m
fi
