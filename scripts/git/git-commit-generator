#!/usr/bin/env bash
#
# git-commit-generator
#
# Usage:
#   git commit-generator
#
# Generate a Git commit message from staged changes using the OpenAI API.
# Uses the modern OpenAI Responses API (2025).
#
# Requires:
#   - OPENAI_API_KEY_GIT environment variable
#   - jq
#

set -euo pipefail

usage() {
  grep '^#' < "$0" | tail -n +2 | cut -c 3-
}


while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help|help)
      usage
      exit 2
      ;;
    -*)
      echo "Unknown argument: $1" 1>&2
      usage
      exit 1
      ;;
  esac
done

if ! command -v jq >/dev/null 2>&1; then
  echo "Error: jq is required" >&2
  exit 1
fi

if [ -z "${OPENAI_API_KEY_GIT:-}" ]; then
  echo "Error: OPENAI_API_KEY_GIT is not set" >&2
  exit 1
fi

diff_output="$(git diff --cached)"
if [ -z "$diff_output" ]; then
  echo "Error: No staged changes" >&2
  exit 1
fi

base_prompt=$(cat <<EOF
Generate a Git commit message for the following staged diff.

Rules:
- Subject line ≤50 characters.
- Blank line after subject.
- Short descriptive body (1–4 sentences).
- No chain-of-thought or explanation.
- Output ONLY the commit message.

Diff:
$diff_output
EOF
)

generate_message() {
  local prompt="$1"
  local payload
  payload=$(jq -n --arg input "$prompt" '
  {
    model: "gpt-4.1-mini",
    input: $input,
    temperature: 0.2,
    max_output_tokens: 200
  }')

  local response
  response=$(curl -s https://api.openai.com/v1/responses \
      -H "Authorization: Bearer ${OPENAI_API_KEY_GIT}" \
      -H "Content-Type: application/json" \
      -d "$payload")

  local api_error
  api_error=$(echo "$response" | jq -r '.error.message // empty')
  if [ -n "$api_error" ]; then
    echo "OpenAI API error: $api_error" >&2
    echo "Full response:" >&2
    echo "$response" >&2
    exit 1
  fi

  local msg
  msg=$(echo "$response" | jq -r '.output[0].content[0].text // empty')
  if [ -z "$msg" ] || [ "$msg" = "null" ]; then
    echo "Error: model returned no commit message." >&2
    echo "Full response:" >&2
    echo "$response" >&2
    exit 1
  fi

  echo "$msg"
}

prompt="$base_prompt"

while true; do
  commit_message=$(generate_message "$prompt")

  echo
  echo "------------------------------------------------------------"
  printf "%s\n" "$commit_message"
  echo "------------------------------------------------------------"
  echo
  read -rp "Use, edit, regenerate, or abort? [y/e/r/N] " ans

  case "$ans" in
    y|Y )
      git commit -m "$commit_message"
      exit 0
      ;;
    e|E )
      tmpfile=$(mktemp)
      printf "%s\n" "$commit_message" > "$tmpfile"

      "${EDITOR:-vi}" "$tmpfile"
      edited_msg=$(cat "$tmpfile")
      rm -f "$tmpfile"

      if [ -z "$edited_msg" ]; then
        echo "Edited message is empty. Aborting."
        exit 1
      fi

      git commit -m "$edited_msg"
      exit 0
      ;;
    r|R )
      read -rp "Enter feedback for regeneration: " fb
      prompt=$(cat <<EOF
$base_prompt

Additional user feedback:
$fb

Regenerate the commit message following all prior rules.
EOF
)
      ;;
    * )
      echo "Aborted."
      exit 1
      ;;
  esac
done
