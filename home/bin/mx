#!/usr/bin/env bash

# defaults to 'start' if none given
subcommand="${1:-start}"
fzf_command="fzf-tmux -d 20 --ansi --no-sort --reverse --tiebreak=index --extended-exact"

function display_help() {
  echo "  Usage: mx [SUBCOMMAND]

  Available subcommands:
    help -- Displays this menu
    ls   -- List all running and available sessions
    tat  -- Attach to a PWD-named session if it exists, otherwise create and attach to it

    Fuzzy-Finder commands:

    sat    -- Select and attach to a running tmux session
    debug  -- Output the shell commands that are generated by tmux.
    delete -- Deletes given project
    new    -- Create a new project file and open it in your editor
    edit   -- Edit a project file

    To be implemented:

    copy [EXISTING] [NEW] -- Copy an existing project to a new project and open.
    start [PROJECT] [SESSION_NAME] -- Start a tmuxinator-managed tmux session.
  "
}

# issue mx help to see subcommand options
if [[ "$subcommand" == "help" ]]; then
  display_help && exit 0
fi

# switch to a session named after the current directory, creating it if it
# doesn't already exist
if [[ "$subcommand" == "tat" ]]; then
  tmux-attach-or-create && exit 0
fi

if [[ "$subcommand" == "ls" ]]; then
  running_sessions="$(tmux ls 2> /dev/null | grep -v 'failed to connect')"
  tmuxinator_templates="$(tmuxinator list | sed -n '1!p')"

  echo "Running Sessions:"
  echo "$(echo "$running_sessions" | sed 's/^/   /')"
  echo
  echo "Available Tmuxinator Templates:"
  echo "$(echo "$tmuxinator_templates" | sed 's/\s\+/\n/g' | sed 's/^/   /')"

  exit 0
fi


if [[ "$subcommand" == "sat"  ]]; then
  available_sessions="$(tmux ls 2> /dev/null | grep -v 'failed to connect')"
  [[ -z "$available_sessions" ]] && echo "No sessions running." && exit 0

  selection="$(echo "$available_sessions" | $fzf_command)"
  session="$(echo "$selection" | sed -E 's/:.+//g')"

  # exit quietly if no session selected
  [[ -z "$session" ]] && exit 0

  echo "tmux attach-session -t $session"
  tmux attach-session -t $session

  exit 0
fi

# all other subcommands forwarded to tmuxinator
if [[ "$subcommand" =~ ^start|debug|delete|new|edit$ ]]; then
  session="$(tmuxinator list | sed -n '1!p' | sed 's/\s\+/\n/g' | $fzf_command)"

  # exit quietly if no session selected
  [[ -z "$session" ]] && exit 0

  echo "tmuxinator $subcommand $session"
  tmuxinator $subcommand $session

  exit 0
fi


echo "  Error: Unrecognized subcommand" && echo
display_help
exit 1
