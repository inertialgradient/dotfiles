#!/usr/bin/env bash

# git pings
#
# Usage:
#   git pings [OPTIONS]
#
# Extracts all areas of responsibility for files modified on the current
# branch (up to origin/master).
#
# Options:
#   -f, --fetch   update remote tracking branch for master
#   -h, --help    display this message

set -e

usage() {
  grep '^#' < "$0" | tail -n +2 | cut -c 3-
}

fetch() {
  printf "updating origin/master..."

  git fetch origin master &>/dev/null && \
    printf "done.\n" ||\
    printf "failed.\n"
}

search_all_modified_files() {
  git diff --name-only "$branching_commit" head |\
    xargs grep 'areas_of_responsibility' -s
}

search_deleted_files() {
  git diff --diff-filter=D "$branching_commit" head |\
    grep 'areas_of_responsibility'
}

areas_of_responsibilty() {
  branching_commit="$(git merge-base head origin/master)"
  (search_all_modified_files & search_deleted_files) | cat
}

while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 2
      ;;
    -f|--fetch)
      fetch
      break
      ;;
    -*)
      echo "Unknown argument: $1" 1>&2
      usage
      exit 1
      ;;
  esac
done

areas_of_responsibilty |\
 ruby -ne 'puts $_.scan(/(?<=:)\w+/)' |\
 sort |\
 uniq |\
 tr "_" "-" |\
 awk '{ print "@github/"$1 }'
