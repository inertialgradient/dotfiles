#!/usr/bin/env bash
#
# git-commit-generator — Generate a Git commit message from staged changes using OpenAI
#
# Usage: git cmg
#
# Requires:
#   - OPENAI_API_KEY_GIT environment variable
#   - jq
#
# Uses the modern OpenAI Responses API (2025).

set -euo pipefail

# --- sanity checks ------------------------------------------------------------

if ! command -v jq >/dev/null 2>&1; then
  echo "Error: jq is required." >&2
  exit 1
fi

if [ -z "${OPENAI_API_KEY_GIT:-}" ]; then
  echo "Error: OPENAI_API_KEY_GIT is not set." >&2
  exit 1
fi

# --- read staged diff ---------------------------------------------------------

diff_output="$(git diff --cached)"

if [ -z "$diff_output" ]; then
  echo "Error: no staged changes." >&2
  exit 1
fi

# --- prepare prompt -----------------------------------------------------------

prompt=$(cat <<EOF
Generate a Git commit message for the following staged diff.

Rules:
- Subject line ≤50 characters.
- Blank line after subject.
- Short descriptive body (1–4 sentences).
- No chain-of-thought or explanation.
- Output ONLY the commit message.

Diff:
$diff_output
EOF
)

# --- call OpenAI API ----------------------------------------------------------

payload=$(jq -n --arg input "$prompt" '
{
  model: "gpt-4.1-mini",
  input: $input,
  temperature: 0.2,
  max_output_tokens: 200
}')

response=$(curl -s https://api.openai.com/v1/responses \
    -H "Authorization: Bearer ${OPENAI_API_KEY_GIT}" \
    -H "Content-Type: application/json" \
    -d "$payload")

# --- check for API error ------------------------------------------------------

api_error=$(echo "$response" | jq -r '.error.message // empty')

if [ -n "$api_error" ]; then
  echo "OpenAI API error: $api_error" >&2
  echo "Full response:" >&2
  echo "$response" >&2
  exit 1
fi

# --- extract commit message ---------------------------------------------------

commit_message=$(echo "$response" | jq -r '
  .output[0].content[0].text // empty
')

if [ -z "$commit_message" ] || [ "$commit_message" = "null" ]; then
  echo "Error: model returned no commit message." >&2
  echo "Full response:" >&2
  echo "$response" >&2
  exit 1
fi

# --- show message and ask for confirmation -----------------------------------

echo
echo "------------------------------------------------------------"
echo "$commit_message"
echo "------------------------------------------------------------"
echo

read -rp "Use this commit message? [y/N] " ans

case "$ans" in
  y|Y )
    git commit -m "$commit_message"
    ;;
  * )
    echo "Aborted."
    exit 1
    ;;
esac
