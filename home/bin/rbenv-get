#!/bin/bash

# Fuzzy-select a ruby to install using rbenv

ruby_version=$(rbenv install -ls |\
  sed "1 d" |\
  sed -e "s/^[ \t ]*//" |\
  fzf-tmux -l 25 --no-sort --reverse --tac --cycle --tiebreak=index)

if [[ -z $ruby_version ]]; then
  echo && echo 'No ruby version selected.'
  exit 1
fi

if [[ -z "$(brew list | grep rbenv-default-gems)" ]]; then
  echo && echo "rbenv-default-gems is not installed. Installing..."
  echo "brew install rbenv-default-gems"
  brew install rbenv-default-gems
  ln -s "$HOME"/.dotfiles/default-gems "$HOME"/.rbenv/default-gems
fi

#-------------------------------------------------------------
export ARCHFLAGS="-arch x86_64"
RUBY_CONFIGURE_OPTS="--with-readline-dir=$(brew --prefix readline) "
RUBY_CONFIGURE_OPTS+="--enable-shared"
export RUBY_CONFIGURE_OPTS
export RUBY_CFLAGS="-march=native -Os"
export CC="clang"
export CXX="clang++"
export RUBY_GC_MALLOC_LIMIT=60000000
export RUBY_GC_HEAP_FREE_SLOTS=200000
#-------------------------------------------------------------

echo && echo "Installing Ruby version: $ruby_version..."
echo "rbenv install $ruby_version"
rbenv install --verbose "$ruby_version"

echo && echo "Generating ctags for default gems..."
echo "RBENV_VERSION=$ruby_version gem ctags"
RBENV_VERSION=$ruby_version gem ctags

echo && echo "Using Ruby $ruby_version in this shell session"
echo rbenv shell "$ruby_version"
