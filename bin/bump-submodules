#!/usr/bin/env bash

if [[ -z "${DOTFILES_DIR}" ]]; then
  echo "Error: DOTFILES_DIR env var not set."
  exit 1
fi

DATE="$(date +'%d %b %Y')"
ORG_HOME="${DOTFILES_DIR}/share/org"
BLOGS_HOME="${DOTFILES_DIR}/share/blogs"


# Commit any org dir changes
echo "Syncing org changes..."

cd "${ORG_HOME}"
git pull --rebase --autostash
git stash pop
git add --all
git commit -m "Update: ${DATE}"
git push origin


# Commit any blog dir changes
echo "Syncing blog changes..."

cd "${BLOGS_HOME}/samizdat"
git pull --rebase --autostash
git stash pop
git add --all
git commit -m "Update: ${DATE}"
git push origin

cd "${BLOGS_HOME}/conclave"
git pull --rebase --autostash
git stash pop
git add --all
git commit -m "Update: ${DATE}"
git push origin


echo "Syncing submodules..."

cd "${DOTFILES_DIR}"
git submodule foreach "git pull origin"
gi submodule | awk '{ print $2 }' | xargs git add

echo "Syncing dotfiles..."

git commit -m "[submodule] Sync ${DATE}"
git push origin

echo "Done."
